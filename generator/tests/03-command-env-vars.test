#(TEST: simple env var mutation)
key=value cmd key=value
#(RESULT)
package main

import "bunster-build/runtime"

func Main(shell *runtime.Shell, streamManager *runtime.StreamManager) {
	func() {
		var commandName = `cmd`
		var arguments []string
		arguments = append(arguments, `key=value`)
		var command = shell.Command(commandName, arguments...)
		command.Env = append(command.Env, `key=`+`value`)
		streamManager := streamManager.Clone()
		defer streamManager.Destroy()
        if stream, err := streamManager.Get(`0`); err != nil {
            shell.HandleError(err)
        } else {
            command.Stdin = stream
        }
        if stream, err := streamManager.Get(`1`); err != nil {
            shell.HandleError(err)
        } else {
            command.Stdout = stream
        }
        if stream, err := streamManager.Get(`2`); err != nil {
            shell.HandleError(err)
        } else {
            command.Stderr = stream
        }
		if err := command.Run(); err != nil {
			shell.HandleError(err)
			return
		}
		shell.ExitCode = command.ProcessState.ExitCode()

	}()
}

#(ENDTEST)



#(TEST: multi env var mutation)

key1=value key2='value' key3="value" \
    key4=value cmd

#(RESULT)
package main

import "bunster-build/runtime"

func Main(shell *runtime.Shell, streamManager *runtime.StreamManager) {
	func() {
		var commandName = `cmd`
		var arguments []string
		var command = shell.Command(commandName, arguments...)
		command.Env = append(command.Env, `key1=`+`value`)
		command.Env = append(command.Env, `key2=`+`value`)
		command.Env = append(command.Env, `key3=`+`value`)
		command.Env = append(command.Env, `key4=`+`value`)
		streamManager := streamManager.Clone()
		defer streamManager.Destroy()
        if stream, err := streamManager.Get(`0`); err != nil {
            shell.HandleError(err)
        } else {
            command.Stdin = stream
        }
        if stream, err := streamManager.Get(`1`); err != nil {
            shell.HandleError(err)
        } else {
            command.Stdout = stream
        }
        if stream, err := streamManager.Get(`2`); err != nil {
            shell.HandleError(err)
        } else {
            command.Stderr = stream
        }
		if err := command.Run(); err != nil {
			shell.HandleError(err)
			return
		}
		shell.ExitCode = command.ProcessState.ExitCode()

	}()
}

#(ENDTEST)
